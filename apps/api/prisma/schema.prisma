generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  INSTRUCTOR
  ADMIN
}

model User {
  id         String    @id @default(uuid())
  clerkId    String    @unique
  email      String    @unique
  role       Role      @default(STUDENT)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  userProfile          UserProfile?
  instructorProfile    InstructorProfile?
  courses             Course[] @relation("InstructorCourses")  
  enrollments          Enrollment[]
  paymentsAsStudent   Payment[] @relation("UserPayments")
  paymentsAsInstructor Payment[] @relation("InstructorPayments")
  reviews              Review[]
  courseProgresses     CourseProgress[] 
}

model UserProfile {
  id         String   @id @default(uuid())
  userId     String   @unique
  name       String
  bio        String?
  avatarUrl  String?
  country    String?
  website   String?
  github    String?
  linkedin  String?
  twitter   String?

  totalCoursesEnrolled Int    @default(0)
  totalHoursWatched    Int    @default(0)
  certificatesEarned   Int    @default(0)

  user       User   @relation(fields: [userId], references: [id])
}

model InstructorProfile {
  id         String    @id @default(uuid())
  userId     String    @unique
  orgName    String?
  bio        String?
  avatarUrl  String?
  country    String?

 totalCoursesPublished Int  @default(0)
 totalStudents         Int  @default(0)
 revenueGenerated      Decimal  @default(0.0)

 user       User  @relation(fields: [userId], references: [id])   
}

model Course {
  id              String  @id @default(uuid())
  instructorId    String  
  title           String
  description     String
  price           Decimal @default(0.0)
  category        String
  published       Boolean  @default(false)
  createdAt       DateTime @default(now())
  thumbnailUrl    String?

  instructor      User   @relation("InstructorCourses", fields: [instructorId], references: [id])
  modules         Module[]
  enrollments     Enrollment[]
  payments        Payment[]
  reviews         Review[]
  courseProgresses      CourseProgress[]
}

model Module {
  id              String  @id @default(uuid())
  courseId        String
  title           String
  description     String?
  order           Int     @default(0)

  course          Course  @relation(fields: [courseId], references: [id])
  lessons         Lesson[]
  moduleProgresses        ModuleProgress[]
}

model Lesson {
  id              String  @id @default(uuid())
  moduleId        String
  title           String
  contentUrl      String
  thumbnailUrl    String
  duration        Int
  order           Int
  isPreview       Boolean @default(false)
  module          Module  @relation(fields: [moduleId], references: [id])
}

model Enrollment {
  id              String  @id @default(uuid())
  userId          String
  courseId        String
  progress        Float   @default(0.0)
  completed       Boolean @default(false)
  createdAt       DateTime  @default(now())

  user            User  @relation(fields: [userId], references: [id])
  course          Course    @relation(fields: [courseId], references: [id])
}

model Payment {
  id              String  @id @default(uuid())
  userId          String
  courseId        String
  instructorId    String
  amount          Decimal
  status          String
  transactionId   String  @unique
  createdAt       DateTime  @default(now())

  user            User  @relation("UserPayments", fields: [userId], references: [id])
  course          Course  @relation(fields: [courseId], references: [id])
  instructor      User  @relation("InstructorPayments", fields: [instructorId], references: [id]) 

  @@index([userId, courseId, instructorId])
}

model Review {
  id              String  @id @default(uuid())
  userId          String
  courseId        String
  rating          Int
  comment         String?
  createdAt       DateTime  @default(now())

  user            User  @relation(fields: [userId], references: [id])
  course          Course  @relation(fields: [courseId], references: [id])
}

model CourseProgress {
  id              String  @id @default(uuid())
  userId          String
  courseId        String
  progress        Float  @default(0.0)
  completed       Boolean  @default(false)

  user            User  @relation(fields: [userId], references: [id])
  course          Course  @relation(fields: [courseId], references: [id])
  modules         ModuleProgress[]
}

model ModuleProgress {
  id              String  @id @default(uuid())
  courseProgressId      String  
  moduleId        String
  progress        Float  @default(0.0)
  completed      Boolean  @default(false)

  courseProgress  CourseProgress  @relation(fields: [courseProgressId], references: [id])
  module          Module  @relation(fields: [moduleId], references: [id])
}

// new schema

model SignUpAttempt {
    attempts             Int      @default(0)
    emailAddress         String
    passwordHash         String
    token                String   @unique
    verificationCodeHash String
    createdAt            DateTime @default(now())
    expiresAt            DateTime
}

model User {
    id              String    @id
    firstName       String?
    lastName        String?
    emailAddress    String    @unique
    passwordHash    String
    verified        Boolean   @default(false)
    passwordEnabled Boolean
    createdAt       DateTime  @default(now())
    updatedAt       DateTime  @updatedAt
    lastSignInAt    DateTime?

    sessions             Session[]
    workspaceMemberships WorkspaceMembership[]
    workspaceActivities  WorkspaceActivity[]
    workspaceInvitations WorkspaceInvitation[]
    boards               Board[]
    lists                List[]
    asAssignorTasks      Task[]                @relation(name: "assignor")
    asAssigneeTasks      Task[]                @relation(name: "assignee")
    notifications        Notification[]
}

model Session {
    id           String   @id
    userAgent    String   @default("unknown")
    ipAddress    String   @default("unknown")
    userId       String
    expiresAt    DateTime
    createdAt    DateTime @default(now())
    lastActiveAt DateTime @default(now())
    updatedAt    DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Workspace {
    id         String  @id
    strictMode Boolean @default(false)
    name       String

    memberships WorkspaceMembership[]
    activities  WorkspaceActivity[]
    invitations WorkspaceInvitation[]
    boards      Board[]
}

enum WorkspaceMemberRole {
    ADMIN
    GUEST
    MEMBER
}

model WorkspaceMembership {
    userId      String
    workspaceId String
    role        WorkspaceMemberRole
    createdAt   DateTime            @default(now())
    updatedAt   DateTime            @updatedAt

    user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

    @@unique([userId, workspaceId])
}

model WorkspaceActivity {
    id          String   @id
    actorId     String
    workspaceId String
    message     String
    createdAt   DateTime @default(now())

    actor     User      @relation(fields: [actorId], references: [id], onDelete: Cascade)
    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model WorkspaceInvitation {
    userId      String
    workspaceId String
    role        WorkspaceMemberRole
    createdAt   DateTime            @default(now())
    updatedAt   DateTime            @updatedAt

    user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

    @@id([userId, workspaceId])
}

model Board {
    id          String   @id
    creatorId   String
    workspaceId String
    title       String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    lists List[]

    creator   User      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
    workspace Workspace @relation(fields: [workspaceId], references: [id])
}

model List {
    id        String   @id
    boardId   String
    creatorId String
    title     String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    tasks Task[]

    creator User  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
    board   Board @relation(fields: [boardId], references: [id], onDelete: Cascade)
}

model Task {
    id          String   @id
    listId      String
    assignorId  String
    assigneeId  String?
    title       String
    description String?
    dueDate     DateTime
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    list     List  @relation(fields: [listId], references: [id])
    assignor User  @relation(name: "assignor", fields: [assignorId], references: [id], onDelete: Cascade)
    assignee User? @relation(name: "assignee", fields: [assigneeId], references: [id], onDelete: SetNull)
}

model Notification {
    id        String   @id
    userId    String
    message   String
    read      Boolean  @default(false)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}